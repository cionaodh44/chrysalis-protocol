<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Chrysalis Protocol - Day 2</title>
    <link rel="stylesheet" href="day1.css">
    <!-- NEW FONT LINKS -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Tomorrow:ital,wght@0,100;0,200;0,300;0,400;0,500;0,600;0,700;0,800;0,900;1,100;1,200;1,300;1,400;1,500;1,600;1,700;1,800;1,900&display=swap" rel="stylesheet">
</head>
<body>
    <audio id="type-sound" src="type.wav"></audio>
    <audio id="choice-sound" src="choice.wav"></audio>
    <audio id="writing-sound" src="writting.wav"></audio>
    <audio id="master-volume-test-sound" src="master_volume_test.wav"></audio>
    <!-- BGM is now handled by index.html for continuous playback -->

    <div id="game-container">
        <!-- Main Game UI -->
        <div id="game-play-area">
            <img id="background-img" src="" alt="Background">
            <img id="char-sprite" src="" alt="Character Sprite">
            <img id="ux-ui-img" src="day2.png" alt="UI Overlay">

            <div id="name-box">
                <span id="speaker-name"></span>
            </div>

            <div id="text-box">
                <div id="dialogue-text"></div>
            </div>

            <div id="choices-container"></div>

            <div id="controls-bar">
                <button id="report-button" class="control-button"></button>
                <button id="hide-controls-button" class="control-button"></button>
            </div>

            <!-- Settings Button -->
            <div id="settings-button" onclick="toggleSettings()"></div>
        </div>

        <!-- Report Overlay -->
        <div id="report-overlay">
            <div id="report-box">
                <h2>Do you want to end the shift?</h2>
                <div>
                    <button onclick="endShift('yes')">Yes</button>
                    <button onclick="endShift('no')">No</button>
                </div>
            </div>
        </div>

        <!-- Day Transition Overlay -->
        <div id="day-transition-overlay">
            <div id="day-transition-text"></div>
        </div>

        <!-- Settings Overlay -->
        <div id="settings-overlay">
            <div id="settings-panel">
                <h2>Settings</h2>
                <div class="setting-item">
                    <span>Master Volume:</span>
                    <input type="range" id="master-volume-slider" min="0" max="1" step="0.01" value="1" oninput="updateMasterVolume(this.value)">
                </div>
                <div class="setting-item">
                    <span>Character Voice:</span>
                    <input type="range" id="char-voice-slider" min="0" max="1" step="0.01" value="1" oninput="updateCharVoiceVolume(this.value)">
                </div>
                <button onclick="toggleSettings()">Close</button>
            </div>
        </div>

    </div>

    <script>
        const gamePlayArea = document.getElementById('game-play-area');
        const backgroundImg = document.getElementById('background-img');
        const charSprite = document.getElementById('char-sprite');
        const uxUiImg = document.getElementById('ux-ui-img');
        const textBox = document.getElementById('text-box');
        const nameBox = document.getElementById('name-box');
        const speakerName = document.getElementById('speaker-name');
        const dialogueTextDiv = document.getElementById('dialogue-text');
        const choicesContainer = document.getElementById('choices-container');
        const controlsBar = document.getElementById('controls-bar');
        const reportOverlay = document.getElementById('report-overlay');
        const dayTransitionOverlay = document.getElementById('day-transition-overlay');
        const dayTransitionText = document.getElementById('day-transition-text');
        const settingsOverlay = document.getElementById('settings-overlay');
        const masterVolumeSlider = document.getElementById('master-volume-slider');
        const charVoiceSlider = document.getElementById('char-voice-slider');

    const typeSound = document.getElementById('type-sound');
    const choiceSound = document.getElementById('choice-sound');
    const writingSound = document.getElementById('writing-sound');
    const masterVolumeTestSound = document.getElementById('master-volume-test-sound');
    const bgm = document.getElementById('bgm');

        let currentSceneIndex = 0;
        let currentTypingInterval;
        let isTyping = false;
        let currentDay = 2; // This is Day 2
        let controlsHidden = false;
        let currentSprite = '';
        let masterVolume = 1;
        let charVoiceVolume = 1;

        const scenes = [
            {
                type: 'day_transition',
                day: 2
            },
            {
                type: 'dialogue',
                background: 'background.png',
                speaker: 'MC',
                text: '“…Wh… what the hell?!”',
                fadeInBackground: true // Custom property to trigger background fade-in
            },
            {
                type: 'dialogue',
                speaker: 'MC',
                sprite: 'day2_normal.png', // New sprite for the creature
                effect: 'fade-in',
                text: '“That—That’s a head. A human head. It wasn’t like this yesterday!”'
            },
            {
                type: 'dialogue',
                speaker: '???',
                sprite: 'day2_normal.png',
                text: '“Y...ou...u.. he...re”'
            },
            {
                type: 'dialogue',
                speaker: 'MC',
                sprite: 'day2_normal.png',
                text: '“No… no, no, no! What ARE you?!”'
            },
            {
                type: 'dialogue',
                speaker: 'Doctor',
                sprite: 'doc.png',
                effect: 'shake',
                text: '“Calm yourself. Panic won’t help you. This is natural.”'
            },
            {
                type: 'dialogue',
                speaker: 'Doctor',
                sprite: 'doc.png',
                text: '“Children grow fast. Think of it like that. It is a child, in its own way.”'
            },
            {
                type: 'dialogue',
                speaker: 'Doctor',
                sprite: 'doc.png',
                text: '“You applied for this. Just do as I told you. Observe. Feed. Report.”'
            },
            {
                type: 'dialogue',
                speaker: 'MC',
                hideNameBox: true,
                keepSprite: true, // Keep the day2_normal.png sprite
                text: '“Children don’t look like… THIS!”'
            },
            {
                type: 'dialogue',
                speaker: 'Doctor',
                sprite: 'doc_talk.png',
                text: '“You will find that comparisons are useful for understanding, not accuracy. Remember—do not fall for its mimicry.”'
            },
            {
                type: 'dialogue',
                speaker: 'Doctor',
                sprite: 'doc_talk.png',
                text: '“…Tomorrow I won’t be here to supervise. But don’t worry. You can handle it. Three days. Stay focused.”'
            },
            {
                type: 'dialogue',
                speaker: 'Doctor',
                sprite: 'doc.png', // Doctor sprite disappears (or changes to a "leaving" sprite if available)
                effect: 'fade-out' // Custom effect to fade out the sprite
            },
            {
                type: 'dialogue',
                speaker: 'MC',
                hideNameBox: true,
                text: '“…She’s leaving me with this thing? Alone?!”'
            },
            {
                type: 'dialogue',
                speaker: '???',
                sprite: 'day2_normal.png',
                text: '“…Mmm… hun…gry…”'
            },
            {
                type: 'dialogue',
                speaker: 'MC',
                sprite: 'day2_normal.png',
                text: '“…Did you… just—talk?!”'
            },
            {
                type: 'choice',
                choices: [
                    { text: 'Feed the creature.', nextSceneIndex: 16 }
                ],
                sprite: 'day2_normal.png' // This sprite should be visible during the choice
            },
            {
                type: 'dialogue',
                speaker: 'MC',
                sprite: 'day2_normal.png',
                text: '“…I… I’ll just… put this here. Don’t… don’t talk to me.”'
            },
            {
                type: 'dialogue',
                speaker: 'Thought',
                sprite: 'day2_normal.png',
                text: '‘Creature lurches forward, eating messily.’',
                hideNameBox: true
            },
            {
                type: 'dialogue',
                speaker: '???',
                sprite: 'day2_normal.png',
                text: '“…He…llo… you…”'
            },
            {
                type: 'dialogue',
                speaker: '???',
                sprite: 'day2_normal.png',
                text: '“…Don’t… leave… me…”'
            },
            {
                type: 'dialogue',
                speaker: 'MC',
                sprite: 'day2_normal.png',
                text: '“You can… you can talk now?! This isn’t right! This isn’t normal growth!”'
            },
            {
                type: 'dialogue',
                speaker: 'Thought',
                sprite: 'day2_normal.png',
                text: '‘It’s watching me the whole time. Like a child staring at a parent… No. No, it’s not human. Don’t think like that.’',
                hideNameBox: true
            },
            {
                type: 'dialogue',
                speaker: 'MC',
                sound: 'writting.wav',
                text: '“Stay away from me. I’ll just… record this down. That’s all I need to do. You’re not getting anything from me.”',
                sprite: 'day2_normal.png'
            },
            {
                type: 'observation_report',
                day: 2,
                text: '[Day two observation: Subject’s form has shifted drastically. Head resembles human structure. Vocalizations closer to words. Behavior deliberately childlike. Possible mimicry. Difficult to remain objective.]',
                next: 'day_transition',
                day_target: 3
            }
        ];

        function playSound(soundElement) {
            if (soundElement) {
                soundElement.volume = masterVolume;
                soundElement.currentTime = 0;
                soundElement.play().catch(e => console.error("Error playing sound:", e));
            }
        }

        function typeText(text, onComplete) {
            isTyping = true;
            let charIndex = 0;
            dialogueTextDiv.innerHTML = '';
            clearTimeout(currentTypingInterval);

            function typeChar() {
                if (charIndex < text.length) {
                    dialogueTextDiv.innerHTML += text.charAt(charIndex);
                    charIndex++;
                    playSound(typeSound);
                    currentTypingInterval = setTimeout(typeChar, 50);
                } else {
                    isTyping = false;
                    if (onComplete) onComplete();
                }
            }
            typeChar();
        }

        function showFullText(text) {
            clearTimeout(currentTypingInterval);
            dialogueTextDiv.innerHTML = text;
            isTyping = false;
        }

        function displayScene(scene) {
            choicesContainer.innerHTML = '';
            dialogueTextDiv.innerHTML = '';
            nameBox.style.display = 'flex';

            if (scene.background) {
                backgroundImg.src = scene.background;
                if (scene.fadeInBackground) {
                    backgroundImg.style.opacity = 0;
                    setTimeout(() => backgroundImg.style.opacity = 1, 50); // Small delay to trigger transition
                } else {
                    backgroundImg.style.opacity = 1;
                }
                uxUiImg.style.display = 'block';
            } else if (currentSceneIndex === 1) { // If first non-transition scene has no explicit background, default to hidden.
                backgroundImg.style.opacity = 0;
                uxUiImg.style.display = 'none';
            }

            // Apply sprite logic
            charSprite.classList.remove('shake', 'zoom-in', 'zoom-out', 'fade-in', 'fade-out'); // Clear all previous effects

            if (scene.sprite) {
                charSprite.src = scene.sprite;
                charSprite.style.display = 'block';
                if (scene.effect === 'fade-in') {
                    charSprite.style.opacity = 0;
                    setTimeout(() => charSprite.style.opacity = 1, 50);
                } else {
                    charSprite.style.opacity = 1;
                }
                currentSprite = scene.sprite;
            } else if (scene.effect === 'fade-out') {
                charSprite.style.opacity = 0;
                // Don't hide display immediately, let CSS transition handle it.
                // After transition, you might want to set display: 'none'
                setTimeout(() => {
                    if (scenes[currentSceneIndex-1] && scenes[currentSceneIndex-1].effect === 'fade-out') {
                         charSprite.style.display = 'none';
                         currentSprite = '';
                    }
                }, 1000); // Duration of fade-out animation
            } else if (!scene.keepSprite) {
                charSprite.style.display = 'none';
                currentSprite = '';
            } else if (scene.keepSprite && currentSprite) {
                charSprite.src = currentSprite;
                charSprite.style.display = 'block';
                charSprite.style.opacity = 1; // Ensure it's visible if kept
            }


            if (scene.effect && scene.effect !== 'fade-in' && scene.effect !== 'fade-out') { // Apply other effects
                charSprite.classList.add(scene.effect);
            }


            if (scene.speaker) {
                speakerName.textContent = scene.speaker;
                nameBox.style.opacity = 1;
                if (scene.hideNameBox) {
                    nameBox.style.opacity = 0;
                }
            } else {
                speakerName.textContent = '';
                nameBox.style.opacity = 0;
            }

            if (scene.sound === 'writting.wav') playSound(writingSound);

            if (scene.type === 'dialogue') {
                typeText(scene.text);
            } else if (scene.type === 'choice') {
                speakerName.textContent = '';
                nameBox.style.opacity = 0;

                if (scene.sprite) {
                    charSprite.src = scene.sprite;
                    charSprite.style.display = 'block';
                    currentSprite = scene.sprite;
                } else if (!currentSprite) {
                    charSprite.style.display = 'none';
                }

                scene.choices.forEach((choice) => {
                    const button = document.createElement('button');
                    button.classList.add('choice-button');
                    button.textContent = choice.text;
                    button.onclick = () => handleChoice(choice);
                    choicesContainer.appendChild(button);
                });
            }
        }

        function handleChoice(choice) {
            playSound(choiceSound);
            currentSceneIndex = choice.nextSceneIndex;
            loadScene();
        }

        function nextDialogue() {
            if (isTyping) {
                showFullText(scenes[currentSceneIndex].text);
                return;
            }

            currentSceneIndex++;
            if (currentSceneIndex < scenes.length) {
                loadScene();
            } else {
                console.log("End of game content for Day 2.");
                if (!reportOverlay.style.display === 'flex' && scenes[currentSceneIndex - 1].type !== 'observation_report') {
                    // If the narrative finishes and we haven't shown the report,
                    // automatically trigger end of shift to progress to the next day.
                    endShift('yes');
                }
            }
        }

        function loadScene() {
            const scene = scenes[currentSceneIndex];

            if (!scene) {
                console.log("No more scenes.");
                return;
            }

            switch (scene.type) {
                case 'dialogue':
                case 'choice':
                    displayScene(scene);
                    break;
                case 'observation_report':
                    showObservationReport(scene);
                    break;
                case 'day_transition':
                    startDayTransition(scene.day);
                    break;
                default:
                    console.error("Unknown scene type:", scene.type);
            }
        }

        function startDayTransition(dayNum) {
            gamePlayArea.style.display = 'none';
            dayTransitionOverlay.style.display = 'flex';
            dayTransitionOverlay.style.backgroundColor = 'black';
            dayTransitionOverlay.style.opacity = 1;

            dayTransitionText.textContent = `Day ${dayNum}`;
            dayTransitionText.style.fontSize = '120px';
            dayTransitionText.classList.remove('fade-out');
            dayTransitionText.classList.add('fade-in-out-day');

            setTimeout(() => {
                dayTransitionText.classList.remove('fade-in-out-day');
                dayTransitionOverlay.style.opacity = 0;
                dayTransitionOverlay.style.display = 'none';
                startGame();
            }, 3000);
        }

        function startGame() {
            gamePlayArea.style.display = 'block';
            // Start from the next scene after the day transition
            currentSceneIndex = scenes.findIndex(s => s.type === 'dialogue' || s.type === 'choice');
            loadScene();
        }

        function showObservationReport(scene) {
            gamePlayArea.style.filter = 'brightness(0.5)';
            textBox.style.transition = 'opacity 0.5s ease-in-out';
            textBox.style.opacity = 0;
            nameBox.style.opacity = 0;
            choicesContainer.style.opacity = 0;
            controlsBar.style.opacity = 0;

            dayTransitionOverlay.style.display = 'flex';
            dayTransitionOverlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
            dayTransitionOverlay.style.opacity = 1;
            dayTransitionText.style.fontSize = '36px';
            dayTransitionText.textContent = scene.text;
            dayTransitionText.classList.remove('fade-out');
            dayTransitionText.classList.add('fade-in');

            dayTransitionOverlay.onclick = null;
            setTimeout(() => {
                const dismissReport = () => {
                    dayTransitionOverlay.removeEventListener('click', dismissReport);
                    dayTransitionText.classList.remove('fade-in');
                    dayTransitionText.classList.add('fade-out');

                    setTimeout(() => {
                        dayTransitionOverlay.style.opacity = 0;
                        dayTransitionOverlay.style.display = 'none';
                        dayTransitionText.classList.remove('fade-out');

                        // --- MODIFICATION START ---
                        // Send a message to the parent frame (index.html) to indicate Day 2 has ended
                        window.parent.postMessage({ type: 'endDay2' }, window.location.origin);
                        // --- MODIFICATION END ---
                    }, 1000);
                };
                dayTransitionOverlay.addEventListener('click', dismissReport);
            }, 500);
        }

        gamePlayArea.addEventListener('click', (e) => {
            const isClickingOnControls = e.target.closest('#controls-bar') || e.target.closest('#choices-container') || e.target.closest('#settings-button');
            if (isClickingOnControls || reportOverlay.style.display === 'flex' || settingsOverlay.style.display === 'flex') {
                return;
            }

            if (isTyping) {
                showFullText(scenes[currentSceneIndex].text);
            } else if (scenes[currentSceneIndex] && scenes[currentSceneIndex].type === 'dialogue') {
                nextDialogue();
            }
        });

        document.addEventListener('keydown', (e) => {
            if (settingsOverlay.style.display === 'flex') {
                if (e.key === 'Escape') {
                    toggleSettings();
                }
                return;
            }

            if (e.key === ' ' || e.key === 'Spacebar') {
                e.preventDefault();
                if (scenes[currentSceneIndex] && (scenes[currentSceneIndex].type === 'dialogue' || scenes[currentSceneIndex].type === 'choice')) {
                    toggleReport();
                }
            } else if (e.key.toLowerCase() === 'x') {
                e.preventDefault();
                toggleControls();
            } else if (e.key === 'Enter' || e.key === 'ArrowRight') {
                if (reportOverlay.style.display === 'none') {
                    if (isTyping) {
                        showFullText(scenes[currentSceneIndex].text);
                    } else if (scenes[currentSceneIndex] && scenes[currentSceneIndex].type === 'dialogue') {
                        nextDialogue();
                    }
                }
            } else if (e.key === 'Escape') {
                toggleSettings();
            }
        });

        function toggleReport() {
            reportOverlay.style.display = reportOverlay.style.display === 'flex' ? 'none' : 'flex';
        }

        function endShift(decision) {
            reportOverlay.style.display = 'none';
            if (decision === 'yes') {
                console.log("Shift ended. Proceeding to next day.");
                showObservationReport({
                    type: 'observation_report',
                    day: currentDay,
                    text: `[Day ${currentDay} observation: Subject’s form has shifted drastically. Head resembles human structure. Vocalizations closer to words. Behavior deliberately childlike. Possible mimicry. Difficult to remain objective.]`,
                    next: 'day_transition',
                    day_target: currentDay + 1
                });
            } else {
                console.log("Shift continues.");
            }
        }

        function toggleControls() {
            controlsHidden = !controlsHidden;
            const elementsToHide = [textBox, nameBox, choicesContainer, controlsBar];
            elementsToHide.forEach(el => {
                el.style.opacity = controlsHidden ? '0' : '1';
                el.style.pointerEvents = controlsHidden ? 'none' : 'auto';
            });
            gamePlayArea.classList.toggle('controls-hidden', controlsHidden);
        }

        function toggleSettings() {
            settingsOverlay.style.display = settingsOverlay.style.display === 'flex' ? 'none' : 'flex';
            if (settingsOverlay.style.display === 'flex') {
                masterVolumeSlider.value = masterVolume;
                charVoiceSlider.value = charVoiceVolume;
                gamePlayArea.style.pointerEvents = 'none';
                reportOverlay.style.pointerEvents = 'none';
            } else {
                gamePlayArea.style.pointerEvents = 'auto';
                reportOverlay.style.pointerEvents = 'auto';
            }
        }

        function updateMasterVolume(value) {
            masterVolume = parseFloat(value);
            typeSound.volume = masterVolume;
            choiceSound.volume = masterVolume;
            writingSound.volume = masterVolume;
            masterVolumeTestSound.volume = masterVolume;
            bgm.volume = masterVolume;
            playSound(masterVolumeTestSound);
        }

        function updateCharVoiceVolume(value) {
            charVoiceVolume = parseFloat(value);
            console.log("Character Voice Volume set to:", charVoiceVolume);
        }

        // Start directly with the day transition for Day 2
    // Start BGM
    // BGM is now handled by index.html for continuous playback
        startDayTransition(currentDay);

        document.addEventListener('mousemove', (e) => {
            const x = (e.clientX / window.innerWidth - 0.5) * 2;
            const y = (e.clientY / window.innerHeight - 0.5) * 2;

            const bgParallaxAmount = 15;
            const charParallaxAmount = 8;

            if (backgroundImg.style.display !== 'none' && backgroundImg.src) {
                backgroundImg.style.transform = `translate(${x * bgParallaxAmount}px, ${y * bgParallaxAmount}px)`;
            }
            if (charSprite.style.display !== 'none' && charSprite.src) {
                charSprite.style.transform = `translateX(-50%) translate(${x * charParallaxAmount}px, ${y * charParallaxAmount}px)`;
            }
        });
    </script>
</body>
</html>